<!DOCTYPE html>
<html lang="en">
    <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>
        .utterances {
            position: relative;
            box-sizing: border-box;
            width: 100%;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
        }
        .utterances-frame {
            color-scheme: light;
            position: absolute;
            left: 0;
            right: 0;
            width: 1px;
            min-width: 100%;
            max-width: 100%;
            height: 100%;
            border: 0;
        }
        </style>
        <title>Custom Github Action</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="./assets/styles/style.css">
        <link rel="stylesheet" href="./assets/styles/style(1).css">
        <link rel="shortcut icon" href="./assets/imgs/favicon.ico">
    </head>
    <body>
        <div class="container">
            <div class="post">
                <h2 class="post-title"><a href="/assets/imgs/bitmap.png">Custom GitHub Actions</a></h2>
                <img src="./assets/imgs/bitmap.webp" class="post-cover">
                <p>Automate, customize, and execute your software development workflows right in your repository with GitHub Actions</p> 
                
                <h2 id="custom-ga">Custom Github Action</h2>
                <p>Actions are individual tasks that you can combine to create jobs and customize your workflow. You can create your own actions, or use and customize actions shared by the GitHub community</p>
                
                <p>For this example, I will create a <code>PCL-Build-Action</code> in docker to compile pcl-cmake base projects. See <a href="https://docs.github.com/en/actions/creating-actions/about-custom-actions#types-of-actions">Types of actions</a> for other types.</p>
                <ol>
                    <li>Create a Github Repository called: <a href="https://github.com/danielTobon43/PCL-Build-Action">PCL-Build-Action</a></li> 
                    <li>Create an <code>action.yml</code> file</li>
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python">name: PCL Build Action
description: Action for building PCL-CMake project which depends on vtk-9/qt5
author: Daniel T.

inputs:
    build_type:
        description: "Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)"
        default: "Release"
        required: false
        type: string

runs:
    using: "docker"
    image: docker://danieltobon43/pcl-docker:1.12.1-alpine3.15-All-GA-v1

# https://actions-cool.github.io/github-action-branding/
branding:
    icon: "package"
    color: "gray-dark"
</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
                    <li>Create a Dockerfile</li>
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python">FROM danieltobon43/pcl-docker:1.12.1-alpine3.15-All-dev AS build
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
                    <li>Create an <code>entrypoint.sh</code> file</li>
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python">#!/bin/sh -l
cmake -B `pwd`/build -DCMAKE_BUILD_TYPE=$INPUT_BUILD_TYPE
cmake --build `pwd`/build --parallel $(nproc) --config $INPUT_BUILD_TYPE
</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
                    <li>Create a <code>README.md</code></li>
                    <li>Save, commit and push the changes to the <code>PCL-Build-Action</code> repository</li>
                    <li>[Optional] deploy the custom github action to the Marketplace</li>
                </ol>
                <h2 id="How-Does-It-Work">How Does It Work?</h2>
                <p>A github action is a github repository with a <code>.yml manifest</code>. This action will compile a CMake project using a Docker container</p>
                <h4 id="yml manifest">yml manifest</h4>
                Actions require a metadata file to define the inputs, outputs and main entrypoint for your action. The metadata filename must be either action.yml or action.yaml. For more information, see <a href="https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions">"Metadata syntax for GitHub Actions."</a>
                <p>The first 3 lines ('name', 'description', 'author') are the metadata for this custom action. The name must be unique since there might be another github action in the marketplace with the same name.</p>
                <p>In this example, I have defined one input called: <code>build_type</code> which is passed to the Docker container as environment variable in the <code>entrypoint.sh</code> file.</p>
                <p>The 'runs' section defined the type of action to be executed. In this example, I am telling to Github to use a 'docker' action with a public docker hub image called: <code>docker://danieltobon43/pcl-docker:1.12.1-alpine3.15-All-GA-v1</code>.</p>
                You can set "image: Dockerfile" to use the provided Dockerfile in the <code>PCL-Build-Action</code> repository, but be aware that every time a new job is executed, an image from the Dockerfile will be compiled (this will cause increasing times in the job execution + possible billing fees from Github).
                <p>The last section is 'branding', which correspond to the logo and colour for the Github Action Marketplace. See <a href="https://actions-cool.github.io/github-action-branding/">"github-action-branding"</a></p>
            
                <h4 id="Dockerfile">Dockerfile</h4>
                This file will be the action to be executed. In this example, the 'Dockefile' will create an image that executes an 'entrypoint.sh' file. The 'danieltobon43/pcl-docker:1.12.1-alpine3.15-All-dev' is the base image to be used where all pcl dependencies such us 'VTK', 'OpenG'L, 'Boost', 'Flann', 'Eigen' are compiled.
                <h4 id="entrypoint.sh">entrypoint.sh</h4>
                This file is the main entrypoint to the Docker container. Will run the cmake commands to compile the project and read any 'INPUT_ARG' provided in the 'yml manifest' as an environment variable. This will similar to have:
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python">docker run -e INPUT_BUILD_TYPE -v GITHUB_WORKSPACE danieltobon43/pcl-docker:1.12.1-alpine3.15-All-dev
</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
                Every input defined in the yml manifest must be prefixed with <code>INPUT_</code> in the main 'entrypoint.sh' file, otherwise won't be recognized.
                <h4 id="README">README</h4>
                This file will be the description of the custom action in the marketplace. In this document you explain the usage of your custom action.
                <h2 id="running-dockerfile">Running Dockerfile in custom action locally</h2>
                The Dockerfile defined in the custom action can be executed locally using <a href="https://github.com/nektos/act">nektos/act</a>. You can download the PCL Build Action repository and run the 'act' command. You will need to modify the 'yml manifest' (action.yml) in the 'PCL Build Action' repository folder to use "Dockerfile" instead. 
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python"># action.yml
name: PCL Build Action
description: Action for building PCL-CMake project which depends on vtk-9/qt5
author: Daniel T.

inputs:
    build_type:
        description: "Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)"
        default: "Release"
        required: false
        type: string

runs:
    using: "docker"
    image: "Dockerfile"

# https://actions-cool.github.io/github-action-branding/
branding:
    icon: "package"
    color: "gray-dark"
</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
The project structure to run the custom github action using the Dockerfile locally is the following:

<p>More information about colored ls output see <a href="https://github.com/athityakumar/colorls">https://github.com/athityakumar/colorls</a></p>

<img src="./assets/imgs/dockerfile-locally.png">
            In this example, I have a 'pcl-visualizer' repository where I have a '.github/workflow/ci.yml' file with the following content.
<div class="code-toolbar"><pre class=" language-python"><code class=" language-python"># ci.yml
name: Continuous integration

on:
  push:
    branches-ignore:
      - documentation
  pull_request:
    branches-ignore:
      - documentation

jobs:
  build-and-test:
    runs-on: ubuntu-20.04

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: PCL Build Action
        uses: ./PCL-Build-Action</code></pre><div class="toolbar"><div class="toolbar-item"><a>Copy</a></div></div></div>
         This ci.yml is instructing Github to use the local PCL-Build-Action repository to run the action.
        <img src="./assets/imgs/act-locally.png">
        Note: The image above has a wrong project path. It is actually: 'danieltc at ~/Downloads/project'
            <h2 id="marketplace">Deploy to Marketplace</h2>
            You can deploy your custom github action to the marketplace
            <img src="./assets/imgs/marketplace.png">
            You will need to tag your repository and then, release the action to the marketplace.
            </div>
        </div>
    </body>
</html>